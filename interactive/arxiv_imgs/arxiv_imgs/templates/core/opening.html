{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}<a href={{ url_for("core.get_random_images") }}>arXiv images - interface</a>{% endblock %}</h1>
{% endblock %}

{% block content %}

  {% if prev_image_id %}

  {% else %}
  <body>
    Showing randomly selected images from arXiv
  </body>
  {% endif %}

  <div id="selected-block" class="row" style="border: ">
    <div id="selected_image" class="img-responsive col-md-6"
    style="display: block; overflow: hidden; width: 300px; height: 0px;
            margin-left: 0; margin-right: auto;
            background-color: #ffffff; margin: 12px; padding: 12px;">
    </div>
    <div id="selected-image-meta" class="col-md-6" style="display: block;"></div>
  </div>

  <!-- {{ prev_image_id }} -->

  <!-- <h2>Selected image:</h2> -->
  <div class="form-inline">
    <div class="form-group mr-2">
      <form name="search" method="post">
        <h2><small>Search via machine learning embedding:</small></h2>
    		<select class="custom-select mt-2 mb-2 mr-2" name="embedding" id="embedding">
          <option value="ternary">ternary</option>
          <option value="VGG16">VGG16</option>
          <option value="raw">raw</option>
        </select>
        <label for="image_id">Target image</label>
        <input for="image_id" name="image_id" id="image_id">

        <!-- <h2><small>Filter results:</small></h2> -->
        <div class="category-dropdown" style="max-width: 600px;">
          <label for="category">Category</label>
          <input type="text" name="category" id="category">
        </div>
        <div class="imageformat-dropdown" style="max-width: 600px;">
          <label for="imageformat">Image format</label>
          <select type="text" name="imageformat" id="imageformat">
            <option value=""></option>
            <option value="PNG">PNG</option>
            <option value="PDF">PDF</option>
            <option value="JP">JPG/JPEG</option>
            <option value="GIF">GIF</option>
            <option value="SVG">SVG</option>
            <option value="PS">PS</option>
            <option value="EPS">EPS</option>
          </select>
        </div>
        <div class="prediction" style="max-width: 600px;">
          <label for="prediction">Prediction</label>
          <input type="text" name="prediction" id="prediction">
        </div>

        <!-- date goes here -->
        <label for="author">Author</label>
        <input name="author" id="author">

        <input type="submit" class="btn btn-light mt-2 mb-2 mr-2" name="btn" value="search-images" id="search-images">
      </form>
      {% if result_total %}
      {{ "Showing the top {} results from a total of {}".format(images_shown, result_total) }}
      {% endif %}
    </div>
  </div>

  <!-- <div class="form-inline">
    <div class="form-group mr-2">
      <div id="multislider"></div>
      <script> var multislider = new Nexus.Multislider('#multislider',{
        'size': [600,100],
        'numberOfSliders': 300,
        'min': 0,
        'max': 1,
        'step': 0,
        'candycane': 3,
        'values': [0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1],
        'smoothing': 0,
        'mode': 'bar'  // 'bar' or 'line'
      }) </script>
      <input type="submit" class="btn btn-light mt-2 mb-2 mr-2" name="btn" value="search-features" id="search-features">
    </div>
  </div> -->

  <div class="grid">
    {% for i, image in enumerate(images) %}
      {% if metadata[i][8]|length > 100 %}
        {% set authors_short = metadata[i][8].split(";")[0] + " et al" %}
      {% else %}
        {% set authors_short = metadata[i][8] %}
      {% endif %}
      <div style="max-width: 224px" class="grid-item" image_id={{image.split(".")[0]}}>
        <img class="grid-item-img" src={{url_for("static", filename="all/"+image+".jpg")}}
          title="metadata" data-toggle="popover" data-html="true" data-trigger="hover"
          data-content="{{ "<b>-- Image<br>filename:</b> {}<br><b>x:</b> {}<b> y:</b> {}<br><b>format:</b> {}<br><b>creator:</b> {}<br><b>prediction:</b> {}<br><br><b>-- Paper<br>identifier:</b> <a href=https://arxiv.org/abs/{}>{}</a><br><b>date:</b> {}<br><b>category:</b> {}<br><b>authors:</b> {}<br><b>title:</b> {}".format(metadata[i][1], metadata[i][2], metadata[i][3], metadata[i][4], metadata[i][5], metadata[i][10], metadata[i][0], metadata[i][0], metadata[i][6], metadata[i][7], authors_short, metadata[i][9])|e }}">
      </div>
    {%- endfor %}
  </div>

  <script>

    // init Packery
    var $grid = $('.grid').packery({
      itemSelector: '.grid-item',
      gutter: 8,
      transitionDuration: 0,
    });
    // layout Packery after each image loads
    $grid.imagesLoaded().progress( function() {
      $grid.packery();
    });

    // $grid.on( 'click', '.grid-item', function( event ) {
    //   $()
    // }

    // console.log("prev_image_id" + {{prev_image_id}})

    function show_selected(img_src, img_data) {
      $("#selected_image").css("height", "300px");
      $("#selected_image").empty().append('<img src=' + img_src + ' style="object-fit: contain; max-width: 100%; max-height: 100%" >');
      $("#selected-image-meta").empty().append(img_data)
    }

    $(".grid-item-img").on("click", function (event) {
  		$(this).toggleClass("active");
      $(".grid-item-img").not(this).removeClass("active");
      var img_src = $(this).attr("src");
      var img_id = $(this).attr("image_id");
      var img_data = $(this).attr("data-content");
      // console.log("showing selected image: " + img_src);
      show_selected(img_src, img_data);
  	});

    $(".grid-item").on("click", function (event) {
      console.log("setting image_id to: " + $(this).attr("image_id"));
      $("#image_id").val($(this).attr("image_id"));
      $(".results").empty().append($(this).attr("image_id"));
  	});

    {% if prev_image_id %}
    $( document ).ready(function() {
      console.log("prev_image_id not empty: " + {{ prev_image_id }});
      var img_src = {{url_for("static", filename="all/"+prev_image_id+".jpg")|tojson}};
      var img_data = {{ "<b>-- Image<br>identifier:</b> {}<br><b>filename:</b> {}<br><b>x:</b> {}<b> y:</b> {}<br><b>format:</b> {}<br><b>creator:</b> {}<br><b>prediction:</b> {}<br><br><b>-- Paper<br>date:</b> {}<br><b>category:</b> {}<br><b>authors:</b> {}<br><b>title:</b> {}".format(si_meta[0], si_meta[1], si_meta[2], si_meta[3], si_meta[4], si_meta[5], si_meta[10], si_meta[6], si_meta[7], si_meta[8], si_meta[9])|tojson }}
      show_selected(img_src, img_data);
    });
    {% endif %}

    var $select = $('#category').selectize({
        delimiter: ',',
        persist: false,
        maxItems: 8,
        valueField: 'cat',
        labelField: 'label',
        searchField:['cat', 'label'],
        options: [
          {'cat': 'astro-ph.GA', 'label': 'Astrophysics of Galaxies'}, {'cat': 'astro-ph.CO', 'label': 'Cosmology and Nongalactic Astrophysics'}, {'cat': 'astro-ph.EP', 'label': 'Earth and Planetary Astrophysics'}, {'cat': 'astro-ph.HE', 'label': 'High Energy Astrophysical Phenomena'}, {'cat': 'astro-ph.IM', 'label': 'Instrumentation and Methods for Astrophysics'}, {'cat': 'astro-ph.SR', 'label': 'Solar and Stellar Astrophysics'}, {'cat': 'cond-mat.dis-nn', 'label': 'Disordered Systems and Neural Networks'}, {'cat': 'cond-mat.mtrl-sci', 'label': 'Materials Science'}, {'cat': 'cond-mat.mes-hall', 'label': 'Mesoscale and Nanoscale Physics'}, {'cat': 'cond-mat.other', 'label': 'Other Condensed Matter'}, {'cat': 'cond-mat.quant-gas', 'label': 'Quantum Gases'}, {'cat': 'cond-mat.soft', 'label': 'Soft Condensed Matter'}, {'cat': 'cond-mat.stat-mech', 'label': 'Statistical Mechanics'}, {'cat': 'cond-mat.str-el', 'label': 'Strongly Correlated Electrons'}, {'cat': 'cond-mat.supr-con', 'label': 'Superconductivity'}, {'cat': 'gr-qc', 'label': 'General Relativity and Quantum Cosmology'}, {'cat': 'hep-ex', 'label': 'High Energy Physics - Experiment'}, {'cat': 'hep-lat', 'label': 'High Energy Physics - Lattice'}, {'cat': 'hep-ph', 'label': 'High Energy Physics - Phenomenology'}, {'cat': 'hep-th', 'label': 'High Energy Physics - Theory'}, {'cat': 'math-ph', 'label': 'Mathematical Physics'}, {'cat': 'nlin.AO', 'label': 'Adaptation and Self-Organizing Systems'}, {'cat': 'nlin.CG', 'label': 'Cellular Automata and Lattice Gases'}, {'cat': 'nlin.CD', 'label': 'Chaotic Dynamics'}, {'cat': 'nlin.SI', 'label': 'Exactly Solvable and Integrable Systems'}, {'cat': 'nlin.PS', 'label': 'Pattern Formation and Solitons'}, {'cat': 'nucl-ex', 'label': 'Nuclear Experiment'}, {'cat': 'nucl-th', 'label': 'Nuclear Theory'}, {'cat': 'physics.acc-ph', 'label': 'Accelerator Physics'}, {'cat': 'physics.app-ph', 'label': 'Applied Physics'}, {'cat': 'physics.ao-ph', 'label': 'Atmospheric and Oceanic Physics'}, {'cat': 'physics.atom-ph', 'label': 'Atomic Physics'}, {'cat': 'physics.atm-clus', 'label': 'Atomic and Molecular Clusters'}, {'cat': 'physics.bio-ph', 'label': 'Biological Physics'}, {'cat': 'physics.chem-ph', 'label': 'Chemical Physics'}, {'cat': 'physics.class-ph', 'label': 'Classical Physics'}, {'cat': 'physics.comp-ph', 'label': 'Computational Physics'}, {'cat': 'physics.data-an', 'label': 'Data Analysis, Statistics and Probability'}, {'cat': 'physics.flu-dyn', 'label': 'Fluid Dynamics'}, {'cat': 'physics.gen-ph', 'label': 'General Physics'}, {'cat': 'physics.geo-ph', 'label': 'Geophysics'}, {'cat': 'physics.hist-ph', 'label': 'History and Philosophy of Physics'}, {'cat': 'physics.ins-det', 'label': 'Instrumentation and Detectors'}, {'cat': 'physics.med-ph', 'label': 'Medical Physics'}, {'cat': 'physics.optics', 'label': 'Optics'}, {'cat': 'physics.ed-ph', 'label': 'Physics Education'}, {'cat': 'physics.soc-ph', 'label': 'Physics and Society'}, {'cat': 'physics.plasm-ph', 'label': 'Plasma Physics'}, {'cat': 'physics.pop-ph', 'label': 'Popular Physics'}, {'cat': 'physics.space-ph', 'label': 'Space Physics'}, {'cat': 'quant-ph', 'label': 'Quantum Physics'}, {'cat': 'math.AG', 'label': 'Algebraic Geometry'}, {'cat': 'math.AT', 'label': 'Algebraic Topology'}, {'cat': 'math.AP', 'label': 'Analysis of PDEs'}, {'cat': 'math.CT', 'label': 'Category Theory'}, {'cat': 'math.CA', 'label': 'Classical Analysis and ODEs'}, {'cat': 'math.CO', 'label': 'Combinatorics'}, {'cat': 'math.AC', 'label': 'Commutative Algebra'}, {'cat': 'math.CV', 'label': 'Complex Variables'}, {'cat': 'math.DG', 'label': 'Differential Geometry'}, {'cat': 'math.DS', 'label': 'Dynamical Systems'}, {'cat': 'math.FA', 'label': 'Functional Analysis'}, {'cat': 'math.GM', 'label': 'General Mathematics'}, {'cat': 'math.GN', 'label': 'General Topology'}, {'cat': 'math.GT', 'label': 'Geometric Topology'}, {'cat': 'math.GR', 'label': 'Group Theory'}, {'cat': 'math.HO', 'label': 'History and Overview'}, {'cat': 'math.IT', 'label': 'Information Theory'}, {'cat': 'math.KT', 'label': 'K-Theory and Homology'}, {'cat': 'math.LO', 'label': 'Logic'}, {'cat': 'math.MP', 'label': 'Mathematical Physics'}, {'cat': 'math.MG', 'label': 'Metric Geometry'}, {'cat': 'math.NT', 'label': 'Number Theory'}, {'cat': 'math.NA', 'label': 'Numerical Analysis'}, {'cat': 'math.OA', 'label': 'Operator Algebras'}, {'cat': 'math.OC', 'label': 'Optimization and Control'}, {'cat': 'math.PR', 'label': 'Probability'}, {'cat': 'math.QA', 'label': 'Quantum Algebra'}, {'cat': 'math.RT', 'label': 'Representation Theory'}, {'cat': 'math.RA', 'label': 'Rings and Algebras'}, {'cat': 'math.SP', 'label': 'Spectral Theory'}, {'cat': 'math.ST', 'label': 'Statistics Theory'}, {'cat': 'math.SG', 'label': 'Symplectic Geometry'}, {'cat': 'cs.AI', 'label': 'Artificial Intelligence'}, {'cat': 'cs.CL', 'label': 'Computation and Language'}, {'cat': 'cs.CC', 'label': 'Computational Complexity'}, {'cat': 'cs.CE', 'label': 'Computational Engineering, Finance, and Science'}, {'cat': 'cs.CG', 'label': 'Computational Geometry'}, {'cat': 'cs.GT', 'label': 'Computer Science and Game Theory'}, {'cat': 'cs.CV', 'label': 'Computer Vision and Pattern Recognition'}, {'cat': 'cs.CY', 'label': 'Computers and Society'}, {'cat': 'cs.CR', 'label': 'Cryptography and Security'}, {'cat': 'cs.DS', 'label': 'Data Structures and Algorithms'}, {'cat': 'cs.DB', 'label': 'Databases'}, {'cat': 'cs.DL', 'label': 'Digital Libraries'}, {'cat': 'cs.DM', 'label': 'Discrete Mathematics'}, {'cat': 'cs.DC', 'label': 'Distributed, Parallel, and Cluster Computing'}, {'cat': 'cs.ET', 'label': 'Emerging Technologies'}, {'cat': 'cs.FL', 'label': 'Formal Languages and Automata Theory'}, {'cat': 'cs.GL', 'label': 'General Literature'}, {'cat': 'cs.GR', 'label': 'Graphics'}, {'cat': 'cs.AR', 'label': 'Hardware Architecture'}, {'cat': 'cs.HC', 'label': 'Human-Computer Interaction'}, {'cat': 'cs.IR', 'label': 'Information Retrieval'}, {'cat': 'cs.IT', 'label': 'Information Theory'}, {'cat': 'cs.LG', 'label': 'Learning'}, {'cat': 'cs.LO', 'label': 'Logic in Computer Science'}, {'cat': 'cs.MS', 'label': 'Mathematical Software'}, {'cat': 'cs.MA', 'label': 'Multiagent Systems'}, {'cat': 'cs.MM', 'label': 'Multimedia'}, {'cat': 'cs.NI', 'label': 'Networking and Internet Architecture'}, {'cat': 'cs.NE', 'label': 'Neural and Evolutionary Computing'}, {'cat': 'cs.NA', 'label': 'Numerical Analysis'}, {'cat': 'cs.OS', 'label': 'Operating Systems'}, {'cat': 'cs.OH', 'label': 'Other Computer Science'}, {'cat': 'cs.PF', 'label': 'Performance'}, {'cat': 'cs.PL', 'label': 'Programming Languages'}, {'cat': 'cs.RO', 'label': 'Robotics'}, {'cat': 'cs.SI', 'label': 'Social and Information Networks'}, {'cat': 'cs.SE', 'label': 'Software Engineering'}, {'cat': 'cs.SD', 'label': 'Sound'}, {'cat': 'cs.SC', 'label': 'Symbolic Computation'}, {'cat': 'cs.SY', 'label': 'Systems and Control'}, {'cat': 'q-bio.BM', 'label': 'Biomolecules'}, {'cat': 'q-bio.GN', 'label': 'Genomics'}, {'cat': 'q-bio.MN', 'label': 'Molecular Networks'}, {'cat': 'q-bio.SC', 'label': 'Subcellular Processes'}, {'cat': 'q-bio.CB', 'label': 'Cell Behavior'}, {'cat': 'q-bio.NC', 'label': 'Neurons and Cognition'}, {'cat': 'q-bio.TO', 'label': 'Tissues and Organs'}, {'cat': 'q-bio.PE', 'label': 'Populations and Evolution'}, {'cat': 'q-bio.QM', 'label': 'Quantitative Methods'}, {'cat': 'q-bio.OT', 'label': 'Other'}, {'cat': 'q-fin.PR', 'label': 'Pricing of Securities'}, {'cat': 'q-fin.RM', 'label': 'Risk Management'}, {'cat': 'q-fin.PM', 'label': 'Portfolio Management'}, {'cat': 'q-fin.TR', 'label': 'Trading and Microstructure'}, {'cat': 'q-fin.MF', 'label': 'Mathematical Finance'}, {'cat': 'q-fin.CP', 'label': 'Computational Finance'}, {'cat': 'q-fin.ST', 'label': 'Statistical Finance'}, {'cat': 'q-fin.GN', 'label': 'General Finance'}, {'cat': 'q-fin.EC', 'label': 'Economics'}, {'cat': 'stat.AP', 'label': 'Applications'}, {'cat': 'stat.CO', 'label': 'Computation'}, {'cat': 'stat.ML', 'label': 'Machine Learning'}, {'cat': 'stat.ME', 'label': 'Methodology'}, {'cat': 'stat.OT', 'label': 'Other Statistics'}, {'cat': 'stat.TH', 'label': 'Theory'}
        ],
        render: {
          item: function(item, escape) {
              return '<div>' +
                  (item.cat ? '<span class="cat">' + escape(item.cat) + ' - </span>' : '') +
                  (item.label ? '<span class="label">' + escape(item.label) + '</span>' : '') +
              '</div>';
          },
          option: function(item, escape) {
              var label = item.cat || item.label;
              var caption = item.cat ? item.label : null;
              return '<div>' +
                  '<span class="label">' + escape(label) + ' - </span>' +
                  (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
              '</div>';
          }
        },
        create: function(input) {
            return {
                cat: input,
                label: input
            }
        }
    });
    var selectize = $select[0].selectize;

    var $ifSelect = $('#imageformat').selectize({
        create: true,
        sortField: 'text'
    });
    var ifSelectize = $ifSelect[0].selectize;

    // $('.input').keypress(function (e) {
    //   if (e.which == 13) {
    //     console.log("key 13 pressed")
    //     $('form#search').submit();
    //     return false;    //<---- Add this line
    //   }
    // });



  	// $(".grid-item").on("dblclick", function (event) {
  	// 	// window.open($(this).attr("meta-href"), "_blank");
    //   $.ajax({
    //     type: "POST",
    //     url: "/core/interface",
    //     data: { image_id : $(this).attr("image_id") },
    //     success: function(result) {
    //       console.log("POST success")
    //       console.log(result.results);
    //       $("#place_for_results").html(response)
    //     },
    //     // handle error
    //     error: function(error) {
    //       console.log("POST error")
    //       console.log(error);
    //     }
    //   })
  	// });

    $(".grid-item").on("dblclick", function (event) {
      console.log("double click");
      // $("#search").trigger('submit');
      // $("#search").submit();
    });

    $(document).ready(function(){
      $('[data-toggle="popover"]').popover({
        // offset: 5
        // placement: 'top',
        // trigger: 'click',
      });
      {% if prev_image_id %}
      $("#image_id").val( {{ prev_image_id }} );
      {% endif %}

      {% if embedding %}
      console.log({{embedding|tojson}});
      var emVal = {{embedding|tojson}};
      $("#embedding").val(emVal);
      {% endif %}

      {% if category %}
      console.log({{category|tojson}});
      var catVal = {{category|tojson}};
      selectize.setValue(catVal.split(","), 1);
      {% endif %}
      // selectize.setValue(["cs.CV","astro-ph.GA"], 1);

      {% if imageformat %}
      console.log({{imageformat|tojson}});
      var imVal = {{imageformat|tojson}};
      ifSelectize.setValue(imVal, 1);
      {% endif %}
      // selectize.setValue(["cs.CV","astro-ph.GA"], 1);

      {% if author %}
      console.log({{author|tojson}});
      var authorVal = {{author|tojson}};
      $("#author").val(authorVal);
      {% endif %}

      {% if prediction %}
      console.log({{prediction|tojson}});
      var predVal = {{prediction|tojson}};
      $("#prediction").val(predVal);
      {% endif %}
    });

    // function return_active(select) {
  	// 	$(".active").each(function () {
  	// 		value = $(this).attr("value");
  	// 		$("#" + select).append(new Option(value, value, false, true));
  	// 	});
  	// };

    // var $grid = $('.grid').imagesLoaded( function() {
    //   // init Packery after all images have loaded
    //   $grid.packery({
    //     itemSelector: '.grid-item',
    //     gutter: 8
    //   });
    // });

    // $('.grid').packery({
    //   itemSelector: '.grid-item',
    //   gutter: 50
    // });

  $('#container').imagesLoaded()
    .always( function( instance ) {
      console.log('all images loaded');
    })
    .done( function( instance ) {
      console.log('all images successfully loaded');
    })
    .fail( function() {
      console.log('all images loaded, at least one is broken');
    })
    .progress( function( instance, image ) {
      var result = image.isLoaded ? 'loaded' : 'broken';
      console.log( 'image is ' + result + ' for ' + image.img.src );
    });
  </script>

{% endblock %}
