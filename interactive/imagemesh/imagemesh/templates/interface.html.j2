{% extends 'base.html' %}

{% block title %}ImageMesh - Interface{% endblock %}

{% block content %}

  <div id="sbar">

    <ul>
      <!-- class="flex-column mb-auto ml-0" -->
      <h1 class="fs-3 mt-3"><a id="main-title" href={{ url_for("core.get_images") }}>ImageMesh</a></h1>

      <div class="row">
        <div id="selected_image" class="selected-image shadow"></div>
      </div>

      <div class="row">
        <div id="selected-image-meta" class="selected-image-meta-box"></div>
      </div>

      <!-- <hr/> -->

      <div class="row">
        <div style="clear: both;"></div>
        <div id="main-form" class="form-inline" onsubmit="$('#loading-spinner').removeClass('d-none');">
          <form name="search" method="post">
            <div class="form-group" id="search-mode-form">
              <h2 class="fs-4">Search the dataset:</h2>

              <!-- <div class="btn-group col-12 d-none" role="group" aria-label="Button to toggle searching by sampling or nearest neighbours">
                <input type="radio" class="btn-check" name="btnradio" id="sample-btn" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="sample-btn">Sample dataset</label>

                <input type="radio" class="btn-check" name="btnradio" id="nn-btn" autocomplete="off">
                <label class="btn btn-outline-primary" for="nn-btn">Nearest neighbours</label>
              </div> -->

              <div>
                <label for="search-mode">Search mode</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="search-mode" id="search-mode-random" value="random" checked>
                  <label class="form-check-label" for="search-mode-random">
                    Random sample
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="search-mode" id="search-mode-nn" value="nn">
                  <label class="form-check-label" for="search-mode-nn">
                    Nearest neighbours
                  </label>
                </div>
              </div>

              <div id=random-text class="d-none" style="display: inline-block;">
                <p class="d-none">Sample dataset</p>
                <!-- <p style="font-size: 1.25em; vertical-align: top;">Sample dataset</p> -->
              </div>

              <!-- <label class="switch d-none">
                <input type="checkbox" name="search_select" id="search_select" value='on' onclick="toggleMode();" class="d-none">
                <span class="slider round d-none"></span>
              </label> -->

              <div id=embedding-text class="input-group mt-3 mb-2">
                <!-- <div class="col align-bottom"> -->
                <label for="embedding">ML embedding</label>
                <!-- class="input-group-text" -->
                <!-- </div> -->
                <div style="display: inline-block; vertical-align: text-bottom;" data-toggle="tooltip" data-placement="top"
                  title='Select which neural network embedding to use for nearest neighbours. More info on the "About" page.'>
                  <i class="bi bi-info-circle"></i>
                </div>
                <div class="col">
                  <select class="form-select" name="embedding" id="embedding">
                    <option value="ternary">ternary</option>
                    <option value="VGG16">VGG16</option>
                    <option value="raw">raw</option>
                    <option value="cats">cats</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col d-none">
                  <label for="image_id" id="image_id_label" class="align-bottom">Target image</label>
                </div>
                <div class="col d-none">
                  <input class="col" style="float: right;"for="image_id" name="image_id" id="image_id" placeholder="Click on an image" type="number" value="{{ prev_image_id }}">
                </div>
              </div>
              <!-- style="vertical-align: middle; max-width: 160px;" -->
            </div>

            <div class="col">
              <div class="full-text-search">
                <label for="fts">Keyword search</label> <!-- Search the database -->
                <div style="display: inline-block; vertical-align: text-bottom;" data-toggle="tooltip" data-placement="top"
                  title="Searches for keyword matches across a number of metadata fields.">
                  <i class="bi bi-info-circle"></i>
                </div>
                <input type="text" name="fts" id="fts" {% if fts %}value="{{fts|e}}"{% endif %} placeholder="Type text to search...">
              </div>
            </div>

            <div class="category-dropdown">
              <label for="category">Archive and category</label>
              <div style="display: inline-block; vertical-align: text-bottom;" data-toggle="tooltip" data-placement="top"
                title="Search by archive and category (subject area). Listed according to the arXiv category taxonomy. Searches first-listed category only.">
                <i class="bi bi-info-circle"></i>
              </div>
              <input type="text" name="category" id="category" placeholder="Select an archive (subject area)...">
            </div>

            <div class="category-name-dropdown">
              <label for="category" class="d-none">Category</label>
              <!-- <div style="display: inline-block; vertical-align: text-bottom;" data-toggle="tooltip" data-placement="top"
                title="Search using the article category (specific subject area). Categories are listed according to the arXiv category taxonomy. Searches first-listed category only.">
                <i class="bi bi-info-circle"></i>
              </div> -->
              <input type="text" name="category-name" id="category-name" placeholder="Select a category...">
            </div>

            <div id="filter-div">
              <button id="filter-btn" type="button" class="btn btn-outline-dark mt-4 mb-1 collapsible" data-toggle="collapse" data-target="#filter-content">Additional filters <i id="filter-icon" class="bi bi-caret-down"></i></button>

              <div id="filter-content" class="filter-content collapse form-group">
                <!-- row 1 -->
                <!-- <div class="row"> -->

                  <div class="col">
                    <div class="author-filter">
                      <label for="author">Author</label>
                      <div style="display: inline-block; vertical-align: text-bottom;" data-toggle="tooltip" data-placement="right"
                        title="Search the authors field of the arXiv article metadata. Searches all authors. The number indicates total number of matching images in this data subset.">
                        <i class="bi bi-info-circle"></i>
                      </div>
                      <input type="text" name="author" id="author" {% if author %}value="{{author|e}}"{% endif %} placeholder="Search by author...">
                    </div>
                  </div>

                  <div class="col">
                    <div class="caption-filter">
                      <label for="caption-filter">Caption</label>
                      <input type="caption" name="caption" id="caption" placeholder="Search by caption keyword...">
                    </div>
                  </div>
                <!-- </div> -->

                <!-- row 2 -->
                <!-- <div class="row"> -->
                  <div class="col">
                    <div class="date-filter">
                      <span><label for="date-start">Date range</label></span>
                      <div style="display: block; margin-bottom: 0.5rem;">
                        <input type="date" id="date-start" name="date-start" min="1986-01-01" max="2020-06-30">
                        -
                        <input type="date" id="date-end" name="date-end" min="1986-01-01" max="2020-06-30">
                      </div>
                    </div>
                  </div>

                  <div class="col">
                    <div class="title-filter">
                      <label for="title">Paper title</label>
                      <input type="text" name="title" id="title" placeholder="Search by title keyword...">
                    </div>
                  </div>

                  <div class="col">
                    <div class="prediction">
                      <label for="prediction">VGG prediction</label>
                      <div style="display: inline-block; vertical-align: text-bottom;" data-toggle="tooltip" data-placement="top"
                        title="Search the predictions made by a VGG16 classifier that was trained on ImageNet. Searches only the top-1 prediction.">
                        <i class="bi bi-info-circle"></i>
                      </div>
                      <input type="text" name="prediction" id="prediction" {% if prediction %}value="{{prediction|e}}"{% endif %} placeholder="Search by VGG16 prediction...">
                    </div>
                  </div>
                <!-- </div> -->

                <!-- row 3 -->
                <!-- <div class="row"> -->
                  <div class="col">
                    <div class="creator-filter">
                      <label for="creator">Creator/Software</label>
                      <div style="display: inline-block; vertical-align: text-bottom;" data-toggle="tooltip" data-placement="top"
                        title="Filter by the 'creator' or 'software' field in the image metadata. The number indicates total number of matching images in this data subset.">
                        <i class="bi bi-info-circle"></i>
                      </div>
                      <input type="text" name="creator" id="creator" placeholder="Search by software creator field...">
                    </div>
                  </div>

                  <div class="col">
                    <div class="imageformat-dropdown">
                      <label for="imageformat">Image format</label>
                      <select type="text" name="imageformat" id="imageformat" placeholder="Select an imageformat...">
                        <option value="">Select an imageformat...</option>
                        <option value="PNG">PNG</option>
                        <option value="PDF">PDF</option>
                        <option value="JPEG">JPEG</option>
                        <option value="GIF">GIF</option>
                        <option value="SVG">SVG</option>
                        <option value="PS">PS</option>
                        <option value="EPS">EPS</option>
                      </select>
                    </div>
                  </div>

                <div class="col">
                  <button type="button" class="btn btn-warning col-12 mt-2" id="clear-filters">Clear filters</button>
                </div>

              </div>

              <div class="col">
                <div id="search-button-div" class="d-flex justify-content-between">
                  <input type="submit" class="btn btn-primary mt-2 mb-2 mr-2" name="btn" value="Search images" id="search-images">
                  <div style="margin-top: auto; margin-bottom: auto;">
                    <div id="loading-spinner" class="spinner-border d-none" role="status" style="margin-top: auto; margin-bottom: auto; margin-left: 1em;">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>

              <div style="height: 100px;">
              </div>
              <!-- justify-content-between -->
              <!-- class="d-flex justify-content-between" -->

            </div>
          </form>


        </div>
      </div>

    </ul>
  </div>

  <div id="description-text" class="mt-2" class="container-fluid" style="display: block; position: relative; left: 360px; top: 0px; margin-bottom: 1em; width: calc(100% - 360px);">

    <div class="row mx-2">
      {% if prev_image_id or nFilters or fts %}
        {% if result_total %}
          <div class="alert alert-secondary col-10" role="alert">
          {% if not embedding %}
            {% set search_mode_text = "results by sampling dataset from <u>{:,}</u> total matching images".format(result_total) %}
          {% else %}
            {% set search_mode_text = "nearest results to the selected image from <u>{:,}</u> total matching images using <u>{}</u> embedding".format(result_total, embedding) %}
          {% endif %}
          {{ "Showing <u>{}</u> {}".format(images_shown, search_mode_text) }}
          </div>
        {% else %}
          <div class="alert alert-secondary col-10" role="alert">
          {% if not embedding %}
            {% set search_mode_text = "results by sampling dataset" %}
          {% else %}
            {% set search_mode_text = "nearest results to the selected image from <u>600,000</u> total images using <u>{}</u> embedding".format(embedding) %}
          {% endif %}
          {{ "Showing <u>{}</u> {}".format(images_shown, search_mode_text) }}
          </div>
        {% endif %}
      {% else %}
        <div class="alert alert-secondary col-10" role="alert">
          Showing sample of images from arXiv - a preprint repository for the sciences.
        </div>
      {% endif %}

      <!-- navigation menu   -->
      <nav id="nav-menu" class="nav col-2 mr-1 pr-1 mt-1 d-flex justify-content-end" style="z-index: 999;">
        <div class="d-flex flex-column">
          <!-- <a class="navbar-brand" href="#">Reconfiguring</a> -->
          <li class="nav-item d-flex justify-content-end">
            <a class="nav-link" href="{{ url_for('core.about') }}">About</a>
          </li>
          <li class="nav-item d-flex justify-content-end">
            <a class="nav-link active" href="{{ url_for('core.get_images') }}">Interface</a>
          </li>
        </div>
      </nav>

      {% if not prev_image_id and not nFilters and not fts %}
        <div class="alert alert-primary col-12" role="alert">
          Click on an image to see metadata. Double click to select image for nearest neighbour search using machine learning embeddings.
        </div>
      {% endif %}

      {% if messages %}
      <div class="alert alert-danger col-12 ml-1" role="alert">
        {% for message in messages %}
          <li>{{ message|e }}</li>
        {% endfor %}
      </div>
      {% endif %}

      </div>
      <hr class="mx-2">
    </div>

	<div style="display:block; top:50%; right: calc(50% - 180px); position:fixed; z-index: 999" class="spinner-border text-primary mx-auto" role="status" id="loading"></div>

  <div id="image-grid" class="image-grid">
    {% for i, image in enumerate(images) %}
      {% if metadict[image]["authors"]|length > 100 %}
        {% set authors_short = metadict[image]["authors"].split(";")[0] + " et al"|e %}
      {% else %}
        {% set authors_short = metadict[image]["authors"]|e %}
      {% endif %}
      {% set pl = metadict[image]["vggpred"].lower().replace(","," ").split() %}
      {% set prediction_formatted = "{} {}<br>{} {}<br>{} {}<br>{} {}<br>{} {}".format(pl[1]|e, pl[0]|e, pl[3]|e, pl[2]|e, pl[5]|e, pl[4]|e, pl[7]|e, pl[6]|e, pl[9]|e, pl[8]|e) %}
      {% set caption = metadict[image]["caption"]|e %}

      <div class="grid-item" image_id={{image.split(".")[0]}}>
        <img class="grid-item-img" src={{url_for("static", filename="web/"+image+".jpg")}}
          prediction="{{ prediction_formatted }}" tab-data="
          <ul class='nav nav-tabs' id='tab-{{image}}' role='tablist'>
            <li class='nav-item' role='presentation'>
              <a class='nav-link tab-link active' id='tab-id' image-id='{{image}}' data-toggle='tab' href='#{{image}}-id' role='tab' aria-controls='id' aria-selected='true'>ID</a>
            </li>
            <li class='nav-item' role='presentation'>
              <a class='nav-link tab-link' id='tab-fm' image-id='{{image}}' data-toggle='tab' href='#{{image}}-format' role='tab' aria-controls='format' aria-selected='false'>Format</a>
            </li>
            <li class='nav-item' role='presentation'>
              <a class='nav-link tab-link' id='tab-cp' image-id='{{image}}' data-toggle='tab' href='#{{image}}-caption' role='tab' aria-controls='caption' aria-selected='false'>Caption</a>
            </li>
          </ul>

          <div class='tab-content' id='tab-content-{{image}}'>
            <div class='tab-pane fade show active' id='tab-{{image}}-id' role='tabpanel' aria-labelledby='id-tab'>
              <b>identifier:</b> <a href='https://arxiv.org/abs/{{metadict[image]['identifier']|e}}' target='_blank' rel='noopener noreferrer'>{{metadict[image]['identifier']|e}}</a><br><b>date:</b> {{metadict[image]['created']|e}}<br><b>category:</b> {{metadict[image]['cat']|e}}<br><b>authors:</b> {{authors_short|e}}<br><b>title:</b> {{metadict[image]['title']|e}}<br>
              </div>
            <div class='tab-pane fade' id='tab-{{image}}-fm' role='tabpanel' aria-labelledby='format-tab'>
              <b>filename:</b> {{metadict[image]['filename']|e}}<br><b>x:</b> {{metadict[image]['x']|e}}<b> y:</b> {{metadict[image]['y']|e}}<br><b>format:</b> {{metadict[image]['imageformat']|e}}<br><b>creator:</b> {{metadict[image]['creator']|e}}<br>
            </div>
            <div class='tab-pane fade' id='tab-{{image}}-cp' role='tabpanel' aria-labelledby='caption-tab'>
              <b>caption:</b> {{caption}}<br>
            </div>
          </div>"
        >
      </div>
    {%- endfor %}
  </div>

  <script>

  function toggleMode() {
    let checkbox = document.getElementById('search-mode-nn');
    console.log("checkbox: " + checkbox.checked)
    // let sampleButton = $('#sample-btn');
    // let nnButton = $('#nn-btn');
    let gray = "#cccccc"
    let black = "#000000"

    imageID = $("#image_id").val()
    console.log("imageID: " + imageID);

    if(checkbox.checked == 1) {
      document.getElementById("random-text").style.color = gray;
      document.getElementById("embedding-text").style.color = black;
      document.getElementById("image_id_label").style.color = black;
      document.getElementById("embedding").disabled = false;
      document.getElementById("image_id").disabled = false;

      document.getElementById("selected_image").style.filter = "none";

      // $('#sample-btn').removeClass('active');
      // $('#nn-btn').addClass('active');
      // $('#nn-btn').click();
      // btn = document.getElementById("search-mode-nn");
      // btn.checked = true;

      if(imageID) {
        console.log("yes there is an image selected when nn chosen");
      } else {
        console.log("no image selected when nn chosen");
        document.getElementById("selected_image").innerHTML = "<em>Please double click on an image to select for nearest neighbour search</em>";
      }

    } else if (checkbox.checked == 0) {
      document.getElementById("random-text").style.color = black;
      document.getElementById("embedding-text").style.color = gray;
      document.getElementById("image_id_label").style.color = gray;
      document.getElementById("embedding").disabled = true;
      document.getElementById("image_id").disabled = true;

      $('#selected_image').css("filter", "grayscale(100%) brightness(90%)");
      // document.getElementById("selected_image").style.filter = "grayscale(100%)";
      // document.getElementById("selected_image").style.filter = "brightness(50%)";

      // $('#nn-btn').removeClass('active');
      // $('#sample-btn').addClass('active');
      // $('#sample-btn').click();
      // btn = document.getElementById("search-mode-random");
      // btn.checked = true;

      // remove text set by clicking on nn radio button
      if( $("#selected_image").is(':contains("Please double click")')) {
        document.getElementById("selected_image").innerHTML = "";
      }
    }
  }

  Selectize.define('enter_key_submit', function (options) {
    var self = this;

    this.onKeyDown = (function (e) {
      var original = self.onKeyDown;

      return function (e) {
        // this.items.length MIGHT change after event propagation.
        // We need the initial value as well. See next comment.
        var initialSelection = this.items.length;
        original.apply(this, arguments);

        if (e.keyCode === 13
            // Necessary because we don't want this to be triggered when an option is selected with Enter after pressing DOWN key to trigger the dropdown options
            && initialSelection && initialSelection === this.items.length
            && this.$control_input.val() === '') {
          self.trigger('submit');
        }
      };
    })();
  });

  $(document).ready(function(){
    // const checkbox = document.getElementById('search_select');
    let checkbox = document.getElementById('search-mode-nn');

    $('#clear-filters').on('click', function (event) {
      console.log("clearFilters called");

      authorSelect.clear();
      captionSelect.clear();

      var ds = document.getElementById("date-start");
      ds.value = '';
      var de = document.getElementById("date-end");
      de.value = '';

      titleSelect.clear();
      predictionSelect.clear();
      creatorSelect.clear();
      ifSelect.clear();
    });

    $('#search-mode-random').on('click', function(event) {
      console.log("search-mode-random pressed");
      toggleMode();
    });

    $('#search-mode-nn').on('click', function(event) {
      console.log("search-mode-nn pressed");
      toggleMode();
    });

    // init Packery
    var $grid = $('.image-grid').packery({
      itemSelector: '.grid-item',
      gutter: 8,
      transitionDuration: 0,
    });
    // layout Packery after each image loads
    $grid.imagesLoaded().progress( function() {
      $grid.packery();
    });

    function show_selected(img_src, img_data, img_prediction) {
      $("#selected_image").css("height", "324px");
      $("#selected-block").css("display", "block");
      let img_src_html = '<img src=' + img_src + ' style="object-fit: contain; max-width: 100%; max-height: 100%; margin-top: auto; margin-bottom: auto;" class="col d-block my-auto;">';
      console.log(img_src_html);
      $("#selected_image").empty().append(img_src_html);
      console.log("prediction: " + img_prediction);
      $('#selected_image').popover('dispose');
      $("#selected_image").popover({
        content: img_prediction,
        title: 'VGG16 prediction',
        html: true,
        // trigger: 'click',
        placement: 'left',
        offset: "80,0",
      });

      var $popele = $('#selected_image');
      $popele.data('state', 'hover');
      var enterShow = function () {
        if ($popele.data('state') === 'hover') {
            $popele.popover('show');
        }
      };
      var exitHide = function () {
        if ($popele.data('state') === 'hover') {
            $popele.popover('hide');
        }
      };
      var clickToggle = function () {
        if ($popele.data('state') === 'hover') {
            $popele.data('state', 'pinned');
        } else {
            $popele.data('state', 'hover')
            // $popele.popover('hover');
        }
      };
      $popele.popover({trigger: 'manual'})
        .on('mouseenter', enterShow)
        .on('mouseleave', exitHide)
        .on('click', clickToggle);

      let btn = document.getElementById('search-mode-nn');
      if( btn.checked == false ) {
        btn.checked = true;
        toggleMode();
      }

      $("#selected-image-meta").empty().append(img_data);

      $('.si-tab-link').on("click", function (event) {
        console.log("si-tab link clicked");
        let imageID = $(this).attr('image-id');
        let tabID = $(this).attr('id');
        console.log("imageID: " + imageID);
        console.log("tabID: " + tabID);
        let tabSelector = tabID.substring(7, 9);
        console.log("tabSelector: " + tabSelector);
        let targetTabID = "#si-tab-content-" + imageID;
        console.log(targetTabID);
        $( targetTabID ).children().removeClass( "show active" );
        let targetTabContent = '#si-tab-' + imageID + '-' + tabSelector;
        console.log("targetTabContent: " + targetTabContent);
        $( targetTabContent ).addClass( "show active" );
      });

      // no longer using MathJax
      // MathJax.typeset();
    }

    function loadSelectedImage(item, itemID, itemSrc, itemTabData, itemPred) {
      $(item).toggleClass("active");
      $(".grid-item-img").not(item).removeClass("active");
      // var img_src = $(item).attr("src");
      var img_src = itemSrc;
      // var img_id = $(item).parent().attr("image_id");
      var img_id = itemID;
      // var img_data = $(this).attr("data-content");
      // var img_data = $(item).attr("tab-data");
      var img_data = itemTabData;
      console.log(img_data);
      img_data = img_data.replace(/id='tab-/g, "id='si-tab-");
      img_data = img_data.replace(/tab-link/g, "si-tab-link");

      img_data =
        "<button id='selected-image-meta-btn' type='button' class='btn btn-outline-dark col-12 collapsible' data-toggle='collapse' data-target='#selected-image-meta-tabs'>Selected image metadata <i id='filter-icon' class='bi bi-caret-down'></i></button>" +
        "<div id='selected-image-meta-tabs' class='content collapse'>" +
        img_data +
        "</div>";

      console.log("img_data: " + img_data);
      // var img_pred = $(item).attr("prediction");
      var img_pred = itemPred;
      // console.log("showing selected image: " + img_src);

      $("#image_id").val(img_id);

      show_selected(img_src, img_data, img_pred);

      console.log("setting image_id to: " + img_id);
      console.log("prediction: " + img_pred);
      $(".results").empty().append(img_id);
    }

    $(".grid-item-img").on("dblclick", function (event) {
      loadSelectedImage(this, $(this).parent().attr("image_id"), $(this).attr("src"), $(this).attr("tab-data"), $(this).attr("prediction"));
    });

    $(".grid-item-img").on("click", function (event) {
      console.log('disposing popovers');
      $(".grid-item-img").not(this).popover('dispose');
      console.log('creating popover');
      console.log(this);
      let imgDiv = "<img class='popover-image' src='" + $(this).attr('src') + "'>";
      // + "' tab-data=" + $(this).attr('tab-data') +
      let tabData = $(this).attr('tab-data');
      let popoverData = imgDiv + tabData;

      let pred = $(this).attr('prediction');
      let imageId = $(this).parent().attr("image_id");
      console.log("popoverData: " + popoverData);
      $(this).popover({
        html: true,
        trigger: 'manual',
        title: 'Image Metadata <button type="button" class="btn-close position-absolute top-0 end-0 mt-1 mb-1" aria-label="Close"></button>',
        sanitize: false,
        // selector: '[rel=selector]',
        // placement: "bottom",
        content: popoverData,
      });
      $(document).on("click", ".popover .btn-close" , function(){
          $(this).parents(".popover").popover('hide');
      });
      $(document).on("click", ".popover-image" , function(){
        console.log("click on .popover-image");
        loadSelectedImage(this, imageId, $(this).attr("src"), tabData, pred);
      });

      $(".grid-item-img").not(this).popover('hide');
      $(this).popover('show');

      $('.tab-link').on("click", function (event) {
        console.log("link clicked");
        let imageID = $(this).attr('image-id');
        let tabID = $(this).attr('id');
        console.log("imageID: " + imageID);
        console.log("tabID: " + tabID);
        let tabSelector = tabID.substring(4, 6);
        console.log("tabSelector: " + tabSelector);
        let targetTabID = "#tab-content-" + imageID;
        console.log(targetTabID);
        $( targetTabID ).children().removeClass( "show active" );
        let targetTabContent = '#tab-' + imageID + '-' + tabSelector;
        console.log("targetTabContent: " + targetTabContent);
        $( targetTabContent ).addClass( "show active" );
      });
    })

    {% if prev_image_id %}
      console.log("prev_image_id not empty: " + {{ prev_image_id }});
      var img_src = {{url_for("static", filename="web/"+prev_image_id+".jpg")|tojson}};
      {% if si_meta_d[prev_image_id]["authors"]|length > 100 %}
        {% set si_authors_short = si_meta_d[prev_image_id]["authors"].split(";")[0] + " et al" %}
      {% else %}
        {% set si_authors_short = si_meta_d[prev_image_id]["authors"] %}
      {% endif %}

      {% set si_caption = si_meta_d[prev_image_id]['caption']|tojson %}

      {% set pl = si_meta_d[prev_image_id]["vggpred"].lower().replace(","," ").split() %}
      {% set si_prediction_formatted = "{} {}<br>{} {}<br>{} {}<br>{} {}<br>{} {}".format(pl[1]|e, pl[0]|e, pl[3]|e, pl[2]|e, pl[5]|e, pl[4]|e, pl[7]|e, pl[6]|e, pl[9]|e, pl[8]|e) %}
      var img_pred = '{% autoescape false %} {{ si_prediction_formatted }} {% endautoescape %}';

      var img_data =
        "<button id='selected-image-meta-btn' type='button' class='btn btn-outline-dark col-12 collapsible' data-toggle='collapse' data-target='#selected-image-meta-tabs'>Selected image metadata <i id='filter-icon' class='bi bi-caret-down'></i></button>" +
        "<div id='selected-image-meta-tabs' class='content collapse'>" +
          "<ul class='nav nav-tabs' id='tab-{{prev_image_id}}' role='tablist'>" +
            "<li class='nav-item' role='presentation'>" +
              "<a class='nav-link tab-link active' id='tab-id' image-id='{{prev_image_id}}' data-toggle='tab' href='#{{prev_image_id}}-id' role='tab' aria-controls='id' aria-selected='true'>ID</a>" +
            "</li>" +
            "<li class='nav-item' role='presentation'>" +
              "<a class='nav-link tab-link' id='tab-fm' image-id='{{prev_image_id}}' data-toggle='tab' href='#{{prev_image_id}}-format' role='tab' aria-controls='format' aria-selected='false'>Format</a>" +
            "</li>" +
            "<li class='nav-item' role='presentation'>" +
              "<a class='nav-link tab-link' id='tab-cp' image-id='{{prev_image_id}}' data-toggle='tab' href='#{{prev_image_id}}-caption' role='tab' aria-controls='caption' aria-selected='false'>Caption</a>" +
            "</li>" +
          "</ul>" +

          "<div class='tab-content' id='tab-content-{{prev_image_id}}'>" +
            "<div class='tab-pane fade show active' id='tab-{{prev_image_id}}-id' role='tabpanel' aria-labelledby='id-tab'>" +
              "<b>identifier:</b> <a href='https://arxiv.org/abs/{{si_meta_d[prev_image_id]['identifier']|e}}' target='_blank' rel='noopener noreferrer'>{{si_meta_d[prev_image_id]['identifier']|e}}</a><br><b>date:</b> {{si_meta_d[prev_image_id]['created']|e}}<br><b>category:</b> {{si_meta_d[prev_image_id]['cat']|e}}<br><b>authors:</b> {{si_authors_short|e}}<br><b>title:</b> {{si_meta_d[prev_image_id]['title']|e}}<br>" +
              "</div>" +
            "<div class='tab-pane fade' id='tab-{{prev_image_id}}-fm' role='tabpanel' aria-labelledby='format-tab'>" +
             "<b>filename:</b> {{si_meta_d[prev_image_id]['filename']|e}}<br><b>x:</b>" + "{{si_meta_d[prev_image_id]['x']|e}}<b> y:</b> {{si_meta_d[prev_image_id]['y']|e}}<br><b>format:</b> {{si_meta_d[prev_image_id]['imageformat']|e}}<br><b>creator:</b> {{si_meta_d[prev_image_id]['creator']|e}}<br>" +
            "</div>" +
            "<div class='tab-pane fade' id='tab-{{prev_image_id}}-cp' role='tabpanel' aria-labelledby='caption-tab'>" +
              "<b>caption:</b> " + {{si_caption|e}} + "<br>" +
            "</div>" +
          "</div>" +
        "</div>";
      // console.log(img_data);

      img_data = img_data.replace(/id='tab-/g, "id='si-tab-");
      img_data = img_data.replace(/tab-link/g, "si-tab-link");

      show_selected(img_src, img_data, img_pred);

      document.getElementById('selected-image-meta-btn').addEventListener('click', function() {
        this.classList.toggle("active");
        var content = this.nextElementSibling;
        if (content.style.display === "block") {
          content.style.display = "none";
        } else {
          content.style.display = "block";
        }
      });

    {% else %}
      $("#selected-block").css("display", "none");
    {% endif %}

    var $select = $('#fts').selectize({
      delimiter: ',',
      persist: false,
      maxItems: 1,
      plugins: ['remove_button', 'enter_key_submit'],
      onInitialize: function () {
        this.on('submit', function () {
          this.$input.closest('form').submit();
        }, this);
      },
      valueField: 'cat',
      labelField: 'label',
      searchField: ['cat', 'label'],
      render: {
        item: function(item, escape) {
            return '<div>' +
                (item.cat ? '<span class="cat">' + escape(item.cat) + '</span>' : '') +
                // (item.label ? '<span class="label">' + escape(item.label) + '</span>' : '') +
            '</div>';
        },
        option: function(item, escape) {
            var label = item.cat || item.label;
            var caption = item.cat ? item.label : null;
            return '<div>' +
                '<span class="label">' + escape(label) + '</span>' +
                // (author ? '<span class="caption">' + escape(author) + '</span>' : '') +
            '</div>';
        }
      },
      create: function(input) {
          return {
              cat: input,
              label: input
          }
      }
    });
    var ftsSelect = $select[0].selectize;

    var $select = $('#author').selectize({
      delimiter: ',',
      persist: false,
      maxItems: 1,
      plugins: ['remove_button', 'enter_key_submit'],
      onInitialize: function () {
        this.on('submit', function () {
          this.$input.closest('form').submit();
        }, this);
      },
      valueField: 'cat',
      labelField: 'label',
      searchField: ['cat', 'label'],
      render: {
        item: function(item, escape) {
            return '<div>' +
                (item.cat ? '<span class="cat">' + escape(item.cat) + '</span>' : '') +
                // (item.label ? '<span class="label">' + escape(item.label) + '</span>' : '') +
            '</div>';
        },
        option: function(item, escape) {
            var label = item.cat || item.label;
            var caption = item.cat ? item.label : null;
            return '<div>' +
                '<span class="label">' + escape(label) + '</span>' +
                // (author ? '<span class="caption">' + escape(author) + '</span>' : '') +
            '</div>';
        }
      },
      create: function(input) {
          return {
              cat: input,
              label: input
          }
      }
    });
    var authorSelect = $select[0].selectize;

    var $select = $('#prediction').selectize({
      delimiter: ',',
      persist: false,
      maxItems: 1,
      plugins: ['remove_button', 'enter_key_submit'],
      onInitialize: function () {
        this.on('submit', function () {
          this.$input.closest('form').submit();
        }, this);
      },
      valueField: 'cat',
      labelField: 'label',
      searchField: ['cat', 'label'],
      options: [
        {'cat': 'oscilloscope', 'label': '86013'}, {'cat': 'web_site', 'label': '78592'}, {'cat': 'rule', 'label': '62818'}, {'cat': 'slide_rule', 'label': '53678'}, {'cat': 'envelope', 'label': '44853'}, {'cat': 'menu', 'label': '33113'}, {'cat': 'bow', 'label': '18544'}, {'cat': 'nematode', 'label': '14257'}, {'cat': 'crane', 'label': '14243'}, {'cat': 'binder', 'label': '11379'}, {'cat': 'spider_web', 'label': '8914'}, {'cat': 'maze', 'label': '7299'}, {'cat': 'crossword_puzzle', 'label': '6993'}, {'cat': 'swing', 'label': '6722'}, {'cat': 'hook', 'label': '6273'}, {'cat': 'jigsaw_puzzle', 'label': '5996'}, {'cat': 'wall_clock', 'label': '5708'}, {'cat': 'analog_clock', 'label': '4913'}, {'cat': 'stupa', 'label': '3418'}, {'cat': 'necklace', 'label': '3414'}, {'cat': 'scale', 'label': '3238'}, {'cat': 'syringe', 'label': '3044'}, {'cat': 'chime', 'label': '3002'}, {'cat': 'screwdriver', 'label': '2922'}, {'cat': 'shower_curtain', 'label': '2425'}, {'cat': 'pole', 'label': '2362'}, {'cat': 'magnetic_compass', 'label': '2209'}, {'cat': 'tripod', 'label': '2134'}, {'cat': 'traffic_light', 'label': '1975'}, {'cat': 'window_screen', 'label': '1830'}, {'cat': 'digital_clock', 'label': '1787'}, {'cat': 'nail', 'label': '1743'}, {'cat': 'whistle', 'label': '1554'}, {'cat': 'switch', 'label': '1465'}, {'cat': 'chain', 'label': '1431'}, {'cat': 'bubble', 'label': '1304'}, {'cat': 'fountain', 'label': '1287'}, {'cat': 'picket_fence', 'label': '1255'}, {'cat': 'safety_pin', 'label': '1249'}, {'cat': 'gong', 'label': '1120'}, {'cat': 'parachute', 'label': '1075'}, {'cat': 'harvestman', 'label': '1058'}, {'cat': 'matchstick', 'label': '1057'}, {'cat': 'handkerchief', 'label': '1050'}, {'cat': 'book_jacket', 'label': '1023'}, {'cat': 'jellyfish', 'label': '999'}, {'cat': 'rubber_eraser', 'label': '908'}, {'cat': 'spotlight', 'label': '887'}, {'cat': 'abacus', 'label': '885'}, {'cat': 'chainlink_fence', 'label': '876'}, {'cat': 'solar_dish', 'label': '855'}, {'cat': 'pinwheel', 'label': '814'}, {'cat': 'scoreboard', 'label': '813'}, {'cat': 'microphone', 'label': '782'}, {'cat': 'hair_slide', 'label': '756'}, {'cat': 'balloon', 'label': '748'}, {'cat': 'coil', 'label': '724'}, {'cat': 'cleaver', 'label': '722'}, {'cat': 'pick', 'label': '720'}, {'cat': 'wardrobe', 'label': '714'}, {'cat': 'plate_rack', 'label': '694'}, {'cat': 'honeycomb', 'label': '689'}, {'cat': 'screw', 'label': '646'}, {'cat': 'ski', 'label': '620'}, {'cat': 'window_shade', 'label': '601'}, {'cat': 'corkscrew', 'label': '600'}, {'cat': 'fountain_pen', 'label': '592'}, {'cat': 'maypole', 'label': '582'}, {'cat': 'monitor', 'label': '576'}, {'cat': 'walking_stick', 'label': '576'}, {'cat': 'umbrella', 'label': '574'}, {'cat': 'candle', 'label': '570'}, {'cat': 'bow_tie', 'label': '541'}, {'cat': 'bib', 'label': '534'}, {'cat': 'pirate', 'label': '530'}, {'cat': 'horizontal_bar', 'label': '509'}, {'cat': 'prayer_rug', 'label': '489'}, {'cat': 'flagpole', 'label': '483'}, {'cat': 'oboe', 'label': '480'}, {'cat': 'suit', 'label': '479'}, {'cat': 'swab', 'label': '471'}, {'cat': 'power_drill', 'label': '448'}, {'cat': 'ballpoint', 'label': '447'}, {'cat': 'volcano', 'label': '426'}, {'cat': 'wig', 'label': '426'}, {'cat': 'sliding_door', 'label': '425'}, {'cat': 'measuring_cup', 'label': '416'}, {'cat': 'fire_screen', 'label': '407'}, {'cat': 'jersey', 'label': '407'}, {'cat': 'Band_Aid', 'label': '401'}, {'cat': 'radio_telescope', 'label': '394'}, {'cat': 'prison', 'label': '387'}, {'cat': 'mouse', 'label': '384'}, {'cat': 'shoji', 'label': '383'}, {'cat': 'street_sign', 'label': '381'}, {'cat': 'brassiere', 'label': '379'}, {'cat': 'Windsor_tie', 'label': '372'}, {'cat': 'container_ship', 'label': '372'}, {'cat': 'carton', 'label': '363'}, {'cat': 'mask', 'label': '359'}, {'cat': 'puck', 'label': '358'}, {'cat': 'quill', 'label': '350'}, {'cat': 'electric_fan', 'label': '348'}, {'cat': 'bell_cote', 'label': '342'}, {'cat': 'doormat', 'label': '342'}, {'cat': 'iPod', 'label': '342'}, {'cat': 'sombrero', 'label': '337'}, {'cat': 'bee_eater', 'label': '335'}, {'cat': 'sundial', 'label': '334'}, {'cat': 'remote_control', 'label': '324'}, {'cat': 'Petri_dish', 'label': '322'}, {'cat': 'airship', 'label': '322'}, {'cat': 'pencil_sharpener', 'label': '311'}, {'cat': 'tray', 'label': '311'}, {'cat': 'lampshade', 'label': '309'}, {'cat': 'rifle', 'label': '302'}, {'cat': 'toilet_seat', 'label': '298'}, {'cat': 'stage', 'label': '297'}, {'cat': 'red_wine', 'label': '294'}, {'cat': 'loupe', 'label': '293'}, {'cat': 'loudspeaker', 'label': '292'}, {'cat': 'croquet_ball', 'label': '290'}, {'cat': 'folding_chair', 'label': '287'}, {'cat': 'ping-pong_ball', 'label': '285'}, {'cat': 'seashore', 'label': '280'}, {'cat': 'mortarboard', 'label': '278'}, {'cat': 'cricket', 'label': '276'}, {'cat': 'lacewing', 'label': '270'}, {'cat': 'wallet', 'label': '266'}, {'cat': 'bolo_tie', 'label': '265'}, {'cat': 'slot', 'label': '264'}, {'cat': 'stole', 'label': '260'}, {'cat': 'suspension_bridge', 'label': '258'}, {'cat': 'warplane', 'label': '256'}, {'cat': 'strainer', 'label': '254'}, {'cat': 'bathing_cap', 'label': '253'}, {'cat': 'face_powder', 'label': '252'}, {'cat': 'lighter', 'label': '249'}, {'cat': 'modem', 'label': '249'}, {'cat': 'cassette', 'label': '245'}, {'cat': 'stethoscope', 'label': '244'}, {'cat': 'poncho', 'label': '243'}, {'cat': 'dishrag', 'label': '242'}, {'cat': 'screen', 'label': '237'}, {'cat': 'pillow', 'label': '236'}, {'cat': 'streetcar', 'label': '236'}, {'cat': 'theater_curtain', 'label': '231'}, {'cat': 'shoe_shop', 'label': '228'}, {'cat': 'stopwatch', 'label': '226'}, {'cat': 'clog', 'label': '219'}, {'cat': 'ant', 'label': '218'}, {'cat': 'lipstick', 'label': '218'}, {'cat': 'long-horned_beetle', 'label': '218'}, {'cat': 'comic_book', 'label': '213'}, {'cat': 'punching_bag', 'label': '213'}, {'cat': 'paper_towel', 'label': '211'}, {'cat': 'radiator', 'label': '210'}, {'cat': 'tennis_ball', 'label': '205'}, {'cat': 'velvet', 'label': '205'}, {'cat': 'desk', 'label': '202'}, {'cat': 'knot', 'label': '199'}, {'cat': 'bonnet', 'label': '198'}, {'cat': 'castle', 'label': '198'}, {'cat': 'shield', 'label': '198'}, {'cat': 'iron', 'label': '196'}, {'cat': 'harp', 'label': '194'}, {'cat': 'shower_cap', 'label': '194'}, {'cat': 'chain_mail', 'label': '185'}, {'cat': 'torch', 'label': '181'}, {'cat': 'golf_ball', 'label': '179'}, {'cat': 'padlock', 'label': '176'}, {'cat': 'toyshop', 'label': '173'}, {'cat': 'computer_keyboard', 'label': '172'}, {'cat': 'lab_coat', 'label': '166'}, {'cat': 'pencil_box', 'label': '166'}, {'cat': 'pug', 'label': '166'}, {'cat': 'soccer_ball', 'label': '165'}, {'cat': 'refrigerator', 'label': '164'}, {'cat': 'file', 'label': '162'}, {'cat': 'lakeside', 'label': '160'}, {'cat': 'paintbrush', 'label': '158'}, {'cat': 'tiger_beetle', 'label': '158'}, {'cat': 'palace', 'label': '156'}, {'cat': 'schooner', 'label': '155'}, {'cat': 'turnstile', 'label': '154'}, {'cat': 'letter_opener', 'label': '153'}, {'cat': 'sock', 'label': '153'}, {'cat': 'fireboat', 'label': '151'}, {'cat': 'television', 'label': '150'}, {'cat': 'washbasin', 'label': '150'}, {'cat': 'wool', 'label': '147'}, {'cat': 'apron', 'label': '145'}, {'cat': 'library', 'label': '145'}, {'cat': 'dumbbell', 'label': '144'}, {'cat': 'maraca', 'label': '144'}, {'cat': 'cockroach', 'label': '141'}, {'cat': 'sea_urchin', 'label': '141'}, {'cat': 'vase', 'label': '140'}, {'cat': 'barbell', 'label': '139'}, {'cat': "jack-o'-lantern", 'label': '138'}, {'cat': 'parallel_bars', 'label': '138'}, {'cat': 'wine_bottle', 'label': '137'}, {'cat': 'brass', 'label': '136'}, {'cat': 'tick', 'label': '135'}, {'cat': 'cinema', 'label': '134'}, {'cat': 'racket', 'label': '133'}, {'cat': 'geyser', 'label': '132'}, {'cat': 'church', 'label': '131'}, {'cat': 'packet', 'label': '131'}, {'cat': 'bucket', 'label': '129'}, {'cat': 'starfish', 'label': '129'}, {'cat': 'garbage_truck', 'label': '126'}, {'cat': 'space_shuttle', 'label': '126'}, {'cat': 'broom', 'label': '124'}, {'cat': 'sarong', 'label': '124'}, {'cat': 'bannister', 'label': '123'}, {'cat': 'cash_machine', 'label': '122'}, {'cat': 'shopping_basket', 'label': '121'}, {'cat': 'liner', 'label': '118'}, {'cat': 'bottlecap', 'label': '117'}, {'cat': 'manhole_cover', 'label': '117'}, {'cat': 'alp', 'label': '116'}, {'cat': 'centipede', 'label': '116'}, {'cat': 'hourglass', 'label': '116'}, {'cat': 'perfume', 'label': '116'}, {'cat': 'dam', 'label': '115'}, {'cat': 'toilet_tissue', 'label': '115'}, {'cat': 'neck_brace', 'label': '114'}, {'cat': 'washer', 'label': '114'}, {'cat': 'bassoon', 'label': '113'}, {'cat': 'birdhouse', 'label': '113'}, {'cat': 'balance_beam', 'label': '112'}, {'cat': 'conch', 'label': '111'}, {'cat': 'sweatshirt', 'label': '111'}, {'cat': 'mitten', 'label': '109'}, {'cat': 'safe', 'label': '109'}, {'cat': 'cliff', 'label': '108'}, {'cat': 'fur_coat', 'label': '107'}, {'cat': 'laptop', 'label': '107'}, {'cat': 'vending_machine', 'label': '107'}, {'cat': 'beacon', 'label': '106'}, {'cat': 'beaker', 'label': '106'}, {'cat': 'electric_guitar', 'label': '105'}, {'cat': 'space_heater', 'label': '105'}, {'cat': 'sunglasses', 'label': '103'}, {'cat': 'vault', 'label': '102'}, {'cat': 'abaya', 'label': '100'}, {'cat': 'pay-phone', 'label': '100'}, {'cat': 'pier', 'label': '100'}, {'cat': 'dragonfly', 'label': '99'}
      ],
      render: {
        item: function(item, escape) {
            return '<div>' +
                (item.cat ? '<span class="cat">' + escape(item.cat) + ' </span>' : '') +
                (item.label ? '<span class="label small">(' + escape(item.label) + ' in total)</span>' : '') +
            '</div>';
        },
        option: function(item, escape) {
            var label = item.cat || item.label;
            var caption = item.cat ? item.label : null;
            return '<div>' +
                '<span class="label">' + escape(label) + ' </span>' +
                (caption ? '<span class="caption small">(' + escape(caption) + ' in total)</span>' : '') +
            '</div>';
        }
      },
      create: function(input) {
          return {
              cat: input,
              // label: input
          }
      }
    });
    var predictionSelect = $select[0].selectize;

    var categoryNameSettings = {
      delimiter: ',',
      persist: false,
      maxItems: 1,
      plugins: ['remove_button', 'enter_key_submit'],
      onInitialize: function () {
        this.on('submit', function () {
          this.$input.closest('form').submit();
        }, this);
      },
      valueField: 'cat',
      labelField: 'label',
      searchField: ['cat', 'label'],
      options: [],
      render: {
        item: function(item, escape) {
            return '<div>' +
                (item.cat ? '<span class="cat">' + escape(item.cat) + ' - </span>' : '') +
                (item.label ? '<span class="label">' + escape(item.label) + '</span>' : '') +
            '</div>';
        },
        option: function(item, escape) {
            var label = item.cat || item.label;
            var caption = item.cat ? item.label : null;
            return '<div>' +
                '<span class="label">' + escape(label) + ' - </span>' +
                (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
            '</div>';
        }
      },
      create: function(input) {
          return {
              cat: input,
              label: ''
          }
      }
    };

    var $select = $('#category-name').selectize(categoryNameSettings);
    var categoryNameSelect = $select[0].selectize;

    var $select = $('#category').selectize({
        delimiter: ',',
        persist: false,
        maxItems: 1,
        plugins: ['remove_button', 'enter_key_submit'],
        onInitialize: function () {
          this.on('submit', function () {
            this.$input.closest('form').submit();
          }, this);
        },
        valueField: 'cat',
        labelField: 'label',
        searchField: ['cat', 'label'],
        options: [
          {'cat': 'cs', 'label': 'Computer Science'}, {'cat': 'econ', 'label': 'Economics'}, {'cat': 'eess', 'label': 'Electrical Engineering and Systems Science'}, {'cat': 'math', 'label': 'Mathematics'}, {'cat': 'astro-ph', 'label': 'Physics: Astrophysics'}, {'cat': 'cond-mat', 'label': 'Physics: Condensed Matter'}, {'cat': 'gr-qc', 'label': 'Physics: General Relativity and Quantum Cosmology'}, {'cat': 'hep-ex', 'label': 'High Energy Physics - Experiment'}, {'cat': 'hep-lat', 'label': 'High Energy Physics - Lattice'}, {'cat': 'hep-ph', 'label': 'High Energy Physics - Phenomenology'}, {'cat': 'hep-th', 'label': 'High Energy Physics - Theory'}, {'cat': 'nlin', 'label': 'Physics: Nonlinear Sciences'}, {'cat': 'nucl-ex', 'label': 'Physics: Nuclear Experiment'}, {'cat': 'nucl-th', 'label': 'Physics: Nuclear Theory'}, {'cat': 'physics', 'label': 'Physics'}, {'cat': 'quant-ph', 'label': 'Quantum Physics'}, {'cat': 'math-ph', 'label': 'Mathematical Physics'}, {'cat': 'q-bio', 'label': 'Quantitative Biology'}, {'cat': 'q-fin', 'label': 'Quantitative Finance'}, {'cat': 'stat', 'label': 'Statistics'}
        ],
        onChange: function(value) {
          console.log("calling loadCategoryName w value: " + value);
          loadCategoryName(value);
        },
        render: {
          item: function(item, escape) {
            return '<div>' +
                (item.cat ? '<span class="cat">' + escape(item.cat) + ' - </span>' : '') +
                (item.label ? '<span class="label">' + escape(item.label) + '</span>' : '') +
            '</div>';
          },
          option: function(item, escape) {
            var label = item.cat || item.label;
            var caption = item.cat ? item.label : null;
            return '<div>' +
                '<span class="label">' + escape(label) + ' - </span>' +
                (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
            '</div>';
          }
        },
        create: function(input) {
          return {
              cat: input,
              label: input
          }
        }
    });
    var categorySelect = $select[0].selectize;

    function loadCategoryName(archive) {

      var categoryNameOptions = {'cs': [{'cat': 'cs.AI', 'label': 'Artificial Intelligence'}, {'cat': 'cs.CL', 'label': 'Computation and Language'}, {'cat': 'cs.CC', 'label': 'Computational Complexity'}, {'cat': 'cs.CE', 'label': 'Computational Engineering, Finance, and Science'}, {'cat': 'cs.CG', 'label': 'Computational Geometry'}, {'cat': 'cs.GT', 'label': 'Computer Science and Game Theory'}, {'cat': 'cs.CV', 'label': 'Computer Vision and Pattern Recognition'}, {'cat': 'cs.CY', 'label': 'Computers and Society'}, {'cat': 'cs.CR', 'label': 'Cryptography and Security'}, {'cat': 'cs.DS', 'label': 'Data Structures and Algorithms'}, {'cat': 'cs.DB', 'label': 'Databases'}, {'cat': 'cs.DL', 'label': 'Digital Libraries'}, {'cat': 'cs.DM', 'label': 'Discrete Mathematics'}, {'cat': 'cs.DC', 'label': 'Distributed, Parallel, and Cluster Computing'}, {'cat': 'cs.ET', 'label': 'Emerging Technologies'}, {'cat': 'cs.FL', 'label': 'Formal Languages and Automata Theory'}, {'cat': 'cs.GL', 'label': 'General Literature'}, {'cat': 'cs.GR', 'label': 'Graphics'}, {'cat': 'cs.AR', 'label': 'Hardware Architecture'}, {'cat': 'cs.HC', 'label': 'Human-Computer Interaction'}, {'cat': 'cs.IR', 'label': 'Information Retrieval'}, {'cat': 'cs.IT', 'label': 'Information Theory'}, {'cat': 'cs.LG', 'label': 'Learning'}, {'cat': 'cs.LO', 'label': 'Logic in Computer Science'}, {'cat': 'cs.MS', 'label': 'Mathematical Software'}, {'cat': 'cs.MA', 'label': 'Multiagent Systems'}, {'cat': 'cs.MM', 'label': 'Multimedia'}, {'cat': 'cs.NI', 'label': 'Networking and Internet Architecture'}, {'cat': 'cs.NE', 'label': 'Neural and Evolutionary Computing'}, {'cat': 'cs.NA', 'label': 'Numerical Analysis'}, {'cat': 'cs.OS', 'label': 'Operating Systems'}, {'cat': 'cs.OH', 'label': 'Other Computer Science'}, {'cat': 'cs.PF', 'label': 'Performance'}, {'cat': 'cs.PL', 'label': 'Programming Languages'}, {'cat': 'cs.RO', 'label': 'Robotics'}, {'cat': 'cs.SI', 'label': 'Social and Information Networks'}, {'cat': 'cs.SE', 'label': 'Software Engineering'}, {'cat': 'cs.SD', 'label': 'Sound'}, {'cat': 'cs.SC', 'label': 'Symbolic Computation'}, {'cat': 'cs.SY', 'label': 'Systems and Control'}], 'econ': [{'cat': 'econ.EM', 'label': 'Econometrics'}, {'cat': 'econ.GN', 'label': 'General Economics'}, {'cat': 'econ.TH', 'label': 'Theoretical Economics'}], 'eess': [{'cat': 'eess.AS', 'label': 'Audio and Speech Processing'}, {'cat': 'eess.IV', 'label': 'Image and Video Processing'}, {'cat': 'eess.SP', 'label': 'Signal Processing'}, {'cat': 'eess.SY', 'label': 'Systems and Control'}], 'math': [{'cat': 'math.AG', 'label': 'Algebraic Geometry'}, {'cat': 'math.AT', 'label': 'Algebraic Topology'}, {'cat': 'math.AP', 'label': 'Analysis of PDEs'}, {'cat': 'math.CT', 'label': 'Category Theory'}, {'cat': 'math.CA', 'label': 'Classical Analysis and ODEs'}, {'cat': 'math.CO', 'label': 'Combinatorics'}, {'cat': 'math.AC', 'label': 'Commutative Algebra'}, {'cat': 'math.CV', 'label': 'Complex Variables'}, {'cat': 'math.DG', 'label': 'Differential Geometry'}, {'cat': 'math.DS', 'label': 'Dynamical Systems'}, {'cat': 'math.FA', 'label': 'Functional Analysis'}, {'cat': 'math.GM', 'label': 'General Mathematics'}, {'cat': 'math.GN', 'label': 'General Topology'}, {'cat': 'math.GT', 'label': 'Geometric Topology'}, {'cat': 'math.GR', 'label': 'Group Theory'}, {'cat': 'math.HO', 'label': 'History and Overview'}, {'cat': 'math.IT', 'label': 'Information Theory'}, {'cat': 'math.KT', 'label': 'K-Theory and Homology'}, {'cat': 'math.LO', 'label': 'Logic'}, {'cat': 'math.MP', 'label': 'Mathematical Physics'}, {'cat': 'math.MG', 'label': 'Metric Geometry'}, {'cat': 'math.NT', 'label': 'Number Theory'}, {'cat': 'math.NA', 'label': 'Numerical Analysis'}, {'cat': 'math.OA', 'label': 'Operator Algebras'}, {'cat': 'math.OC', 'label': 'Optimization and Control'}, {'cat': 'math.PR', 'label': 'Probability'}, {'cat': 'math.QA', 'label': 'Quantum Algebra'}, {'cat': 'math.RT', 'label': 'Representation Theory'}, {'cat': 'math.RA', 'label': 'Rings and Algebras'}, {'cat': 'math.SP', 'label': 'Spectral Theory'}, {'cat': 'math.ST', 'label': 'Statistics Theory'}, {'cat': 'math.SG', 'label': 'Symplectic Geometry'}], 'astro-ph': [{'cat': 'astro-ph.GA', 'label': 'Astrophysics of Galaxies'}, {'cat': 'astro-ph.CO', 'label': 'Cosmology and Nongalactic Astrophysics'}, {'cat': 'astro-ph.EP', 'label': 'Earth and Planetary Astrophysics'}, {'cat': 'astro-ph.HE', 'label': 'High Energy Astrophysical Phenomena'}, {'cat': 'astro-ph.IM', 'label': 'Instrumentation and Methods for Astrophysics'}, {'cat': 'astro-ph.SR', 'label': 'Solar and Stellar Astrophysics'}], 'cond-mat': [{'cat': 'cond-mat.dis-nn', 'label': 'Disordered Systems and Neural Networks'}, {'cat': 'cond-mat.mtrl-sci', 'label': 'Materials Science'}, {'cat': 'cond-mat.mes-hall', 'label': 'Mesoscale and Nanoscale Physics'}, {'cat': 'cond-mat.other', 'label': 'Other Condensed Matter'}, {'cat': 'cond-mat.quant-gas', 'label': 'Quantum Gases'}, {'cat': 'cond-mat.soft', 'label': 'Soft Condensed Matter'}, {'cat': 'cond-mat.stat-mech', 'label': 'Statistical Mechanics'}, {'cat': 'cond-mat.str-el', 'label': 'Strongly Correlated Electrons'}, {'cat': 'cond-mat.supr-con', 'label': 'Superconductivity'}], 'gr-qc': [{'cat': 'gr-qc', 'label': 'General Relativity and Quantum Cosmology'}], 'hep-ex': [{'cat': 'hep-ex', 'label': 'High Energy Physics - Experiment'}], 'hep-lat': [{'cat': 'hep-lat', 'label': 'High Energy Physics - Lattice'}], 'hep-ph': [{'cat': 'hep-ph', 'label': 'High Energy Physics - Phenomenology'}], 'hep-th': [{'cat': 'hep-th', 'label': 'High Energy Physics - Theory'}], 'math-ph': [{'cat': 'math-ph', 'label': 'Mathematical Physics'}], 'nlin': [{'cat': 'nlin.AO', 'label': 'Adaptation and Self-Organizing Systems'}, {'cat': 'nlin.CG', 'label': 'Cellular Automata and Lattice Gases'}, {'cat': 'nlin.CD', 'label': 'Chaotic Dynamics'}, {'cat': 'nlin.SI', 'label': 'Exactly Solvable and Integrable Systems'}, {'cat': 'nlin.PS', 'label': 'Pattern Formation and Solitons'}], 'nucl-ex': [{'cat': 'nucl-ex', 'label': 'Nuclear Experiment'}], 'nucl-th': [{'cat': 'nucl-th', 'label': 'Nuclear Theory'}], 'physics': [{'cat': 'physics.acc-ph', 'label': 'Accelerator Physics'}, {'cat': 'physics.app-ph', 'label': 'Applied Physics'}, {'cat': 'physics.ao-ph', 'label': 'Atmospheric and Oceanic Physics'}, {'cat': 'physics.atom-ph', 'label': 'Atomic Physics'}, {'cat': 'physics.atm-clus', 'label': 'Atomic and Molecular Clusters'}, {'cat': 'physics.bio-ph', 'label': 'Biological Physics'}, {'cat': 'physics.chem-ph', 'label': 'Chemical Physics'}, {'cat': 'physics.class-ph', 'label': 'Classical Physics'}, {'cat': 'physics.comp-ph', 'label': 'Computational Physics'}, {'cat': 'physics.data-an', 'label': 'Data Analysis, Statistics and Probability'}, {'cat': 'physics.flu-dyn', 'label': 'Fluid Dynamics'}, {'cat': 'physics.gen-ph', 'label': 'General Physics'}, {'cat': 'physics.geo-ph', 'label': 'Geophysics'}, {'cat': 'physics.hist-ph', 'label': 'History and Philosophy of Physics'}, {'cat': 'physics.ins-det', 'label': 'Instrumentation and Detectors'}, {'cat': 'physics.med-ph', 'label': 'Medical Physics'}, {'cat': 'physics.optics', 'label': 'Optics'}, {'cat': 'physics.ed-ph', 'label': 'Physics Education'}, {'cat': 'physics.soc-ph', 'label': 'Physics and Society'}, {'cat': 'physics.plasm-ph', 'label': 'Plasma Physics'}, {'cat': 'physics.pop-ph', 'label': 'Popular Physics'}, {'cat': 'physics.space-ph', 'label': 'Space Physics'}], 'quant-ph': [{'cat': 'quant-ph', 'label': 'Quantum Physics'}], 'q-bio': [{'cat': 'q-bio.BM', 'label': 'Biomolecules'}, {'cat': 'q-bio.GN', 'label': 'Genomics'}, {'cat': 'q-bio.MN', 'label': 'Molecular Networks'}, {'cat': 'q-bio.SC', 'label': 'Subcellular Processes'}, {'cat': 'q-bio.CB', 'label': 'Cell Behavior'}, {'cat': 'q-bio.NC', 'label': 'Neurons and Cognition'}, {'cat': 'q-bio.TO', 'label': 'Tissues and Organs'}, {'cat': 'q-bio.PE', 'label': 'Populations and Evolution'}, {'cat': 'q-bio.QM', 'label': 'Quantitative Methods'}, {'cat': 'q-bio.OT', 'label': 'Other'}], 'q-fin': [{'cat': 'q-fin.PR', 'label': 'Pricing of Securities'}, {'cat': 'q-fin.RM', 'label': 'Risk Management'}, {'cat': 'q-fin.PM', 'label': 'Portfolio Management'}, {'cat': 'q-fin.TR', 'label': 'Trading and Microstructure'}, {'cat': 'q-fin.MF', 'label': 'Mathematical Finance'}, {'cat': 'q-fin.CP', 'label': 'Computational Finance'}, {'cat': 'q-fin.ST', 'label': 'Statistical Finance'}, {'cat': 'q-fin.GN', 'label': 'General Finance'}, {'cat': 'q-fin.EC', 'label': 'Economics'}], 'stat': [{'cat': 'stat.AP', 'label': 'Applications'}, {'cat': 'stat.CO', 'label': 'Computation'}, {'cat': 'stat.ML', 'label': 'Machine Learning'}, {'cat': 'stat.ME', 'label': 'Methodology'}, {'cat': 'stat.OT', 'label': 'Other Statistics'}, {'cat': 'stat.TH', 'label': 'Theory'}]};

      if (!archive.length) {
        categoryNameSelect.clear();
        categoryNameSelect.clearOptions();
        return;
      } else {
        categoryNameSelect.disable();
        console.log("selectize archive: " + archive);
        categoryNameSelect.clear();
        categoryNameSelect.clearOptions();
        categoryNameSelect.load(function(callback) {
          callback(categoryNameOptions[archive]);
        });
        categoryNameSelect.enable();
      }
    }

    var $select = $('#creator').selectize({
        delimiter: ',',
        persist: false,
        maxItems: 1,
        plugins: ['remove_button', 'enter_key_submit'],
        onInitialize: function () {
          this.on('submit', function () {
            this.$input.closest('form').submit();
          }, this);
        },
        valueField: 'cat',
        labelField: 'label',
        searchField: ['cat', 'label'],
        options: [
          {'cat': '-', 'label': '137591'}, {'cat': 'MATLAB', 'label': '95290'}, {'cat': 'matplotlib', 'label': '91527'}, {'cat': 'Mathematica', 'label': '49196'}, {'cat': 'cairo', 'label': '42486'}, {'cat': 'IDL', 'label': '38367'}, {'cat': 'gnuplot', 'label': '37288'}, {'cat': 'fig2dev', 'label': '29881'}, {'cat': 'ROOT', 'label': '27784'}, {'cat': 'Illustrator', 'label': '26938'}, {'cat': 'dvips', 'label': '21988'}, {'cat': 'Grace', 'label': '20276'}, {'cat': 'Ghostscript', 'label': '19823'}, {'cat': 'GIMP', 'label': '14366'}, {'cat': 'TeX', 'label': '14330'}, {'cat': 'SM', 'label': '13157'}, {'cat': 'HIGZ', 'label': '12747'}, {'cat': 'R', 'label': '11687'}, {'cat': 'PGPLOT', 'label': '9175'}, {'cat': 'OriginLab', 'label': '8876'}, {'cat': 'Photoshop', 'label': '8534'}, {'cat': 'CorelDRAW', 'label': '8283'}, {'cat': 'ImageMagick', 'label': '8050'}, {'cat': 'Acrobat', 'label': '7109'}, {'cat': 'PowerPoint', 'label': '5339'}, {'cat': 'jpeg2ps', 'label': '4851'}, {'cat': 'Ipe', 'label': '4675'}, {'cat': 'PScript5', 'label': '4641'}, {'cat': 'XV', 'label': '3659'}, {'cat': 'OmniGraffle', 'label': '3607'}, {'cat': 'Keynote', 'label': '3272'}, {'cat': 'inkscape', 'label': '2947'}, {'cat': 'xmgr', 'label': '2778'}, {'cat': 'LaTeX', 'label': '2682'}, {'cat': '', 'label': '2578'}, {'cat': 'GraphicConverter', 'label': '2234'}, {'cat': 'PSCRIPT', 'label': '2218'}, {'cat': 'GTVIRT', 'label': '1718'}, {'cat': 'Preview', 'label': '1705'}, {'cat': 'Wolfram', 'label': '1401'}, {'cat': 'Visio', 'label': '1332'}, {'cat': 'Tgif', 'label': '1327'}, {'cat': 'Unknown', 'label': '1305'}, {'cat': 'FreeHEP', 'label': '1283'}, {'cat': 'ACE/gr', 'label': '1272'}, {'cat': 'Ipelib', 'label': '1172'}, {'cat': 'KaleidaGraph', 'label': '1152'}, {'cat': 'dvipsk', 'label': '1125'}, {'cat': 'Unified', 'label': '1079'}, {'cat': 'gnome-screenshot', 'label': '1058'}, {'cat': 'Veusz', 'label': '947'}, {'cat': 'TECPLOT', 'label': '916'}, {'cat': 'Draw', 'label': '856'}, {'cat': 'fko', 'label': '811'}, {'cat': 'LibreOffice', 'label': '797'}, {'cat': 'Canvas', 'label': '781'}, {'cat': 'Maple', 'label': '777'}, {'cat': 'Sun', 'label': '767'}, {'cat': 'ImageReady', 'label': '755'}, {'cat': 'Shotwell', 'label': '747'}, {'cat': 'Office', 'label': '707'}, {'cat': 'Paint', 'label': '692'}, {'cat': 'Mayura', 'label': '655'}, {'cat': 'Igor', 'label': '649'}, {'cat': 'pdfresizer', 'label': '630'}, {'cat': 'PyX', 'label': '609'}, {'cat': 'Chromium', 'label': '597'}, {'cat': 'Tk', 'label': '595'}, {'cat': 'EPS-conv', 'label': '592'}, {'cat': 'MetaPost', 'label': '579'}, {'cat': 'Word', 'label': '575'}, {'cat': 'GSview', 'label': '566'}, {'cat': 'GRA2PS', 'label': '540'}, {'cat': '3-Heights', 'label': '534'}, {'cat': 'pnmtops', 'label': '532'}, {'cat': 'GLE', 'label': '522'}, {'cat': 'Mathematica-PSRender', 'label': '511'}, {'cat': 'IgorPro', 'label': '501'}, {'cat': 'user', 'label': '473'}, {'cat': 'xpdf/pdftops', 'label': '469'}, {'cat': 'Dia', 'label': '466'}, {'cat': 'TRIUMF', 'label': '460'}, {'cat': '0', 'label': '436'}, {'cat': 'Corel', 'label': '435'}, {'cat': 'Administrator', 'label': '423'}, {'cat': 'FreeHand', 'label': '414'}, {'cat': 'AIPS', 'label': '390'}, {'cat': '050MATLAB', 'label': '380'}, {'cat': 'RAL', 'label': '376'}, {'cat': 'Excel', 'label': '367'}, {'cat': 'Asymptote', 'label': '347'}, {'cat': 'Image', 'label': '336'}, {'cat': 'XeTeX', 'label': '334'}, {'cat': 'MiKTeX', 'label': '333'}, {'cat': 'PS4', 'label': '327'}, {'cat': 'ImageMark', 'label': '317'}, {'cat': 'Quartz', 'label': '315'}, {'cat': 'Lick', 'label': '315'}, {'cat': 'Impress', 'label': '308'}, {'cat': 'pdftk', 'label': '282'}, {'cat': 'graphviz', 'label': '280'}, {'cat': 'Aladdin', 'label': '272'}, {'cat': 'Serif', 'label': '261'}, {'cat': 'David', 'label': '259'}, {'cat': 'KDE', 'label': '258'}, {'cat': 'sejda', 'label': '255'}, {'cat': 'imgtops', 'label': '250'}, {'cat': 'Photo', 'label': '233'}, {'cat': 'IslandDraw', 'label': '228'}, {'cat': 'module', 'label': '223'}, {'cat': 'Jasc', 'label': '220'}, {'cat': 'NT', 'label': '218'}, {'cat': '()', 'label': '214'}, {'cat': 'GL2PS', 'label': '209'}, {'cat': 'MapleV', 'label': '202'}, {'cat': 'jpeg2eps', 'label': '198'}, {'cat': 'libplot', 'label': '186'}, {'cat': 'Gist', 'label': '185'}, {'cat': 'admin', 'label': '177'}, {'cat': 'SigmaPlot', 'label': '176'}, {'cat': 'yExport', 'label': '175'}, {'cat': 'QtiPlot', 'label': '174'}, {'cat': 'Mozilla/5', 'label': '171'}, {'cat': 'AutoCAD', 'label': '162'}, {'cat': 'WAVE', 'label': '160'}, {'cat': 'Pages', 'label': '157'}, {'cat': 'Michael', 'label': '155'}, {'cat': 'Online2PDF', 'label': '147'}, {'cat': 'Google', 'label': '145'}, {'cat': 'Alex', 'label': '139'}, {'cat': 'EpsGraphics', 'label': '133'}, {'cat': 'Qt', 'label': '124'}, {'cat': 'Shutter', 'label': '123'}, {'cat': 'InDesign', 'label': '122'}, {'cat': 'Pyxplot', 'label': '122'}, {'cat': 'PS5', 'label': '122'}, {'cat': 'TriMetrix', 'label': '120'}, {'cat': 'sgi2ueps', 'label': '118'}, {'cat': 'Feynman', 'label': '117'}, {'cat': 'Axum', 'label': '113'}, {'cat': 'FeynDiagram', 'label': '112'}, {'cat': 'PSIKern', 'label': '111'}, {'cat': 'lenovo', 'label': '110'}, {'cat': 'Pixelmator', 'label': '109'}, {'cat': 'iDraw', 'label': '108'}, {'cat': 'Apache', 'label': '104'}, {'cat': 'EpsGraphics2D', 'label': '103'}, {'cat': 'ipetoipe', 'label': '103'}, {'cat': 'Microsoft', 'label': '101'}, {'cat': 'chris', 'label': '100'}, {'cat': 'Frank', 'label': '97'}, {'cat': 'Graphic', 'label': '95'}, {'cat': 'proFit', 'label': '94'}, {'cat': 'a', 'label': '94'}, {'cat': 'Wang', 'label': '93'}, {'cat': 'Micrografx', 'label': '90'}, {'cat': 'peter', 'label': '90'}, {'cat': 'DISLIN', 'label': '89'}, {'cat': 'Stefan', 'label': '89'}, {'cat': 'PLplot', 'label': '87'}, {'cat': 'Daniel', 'label': '86'}, {'cat': 'Sketch', 'label': '85'}, {'cat': 'Andrea', 'label': '84'}, {'cat': 'Paul', 'label': '83'}, {'cat': 'Zamzar', 'label': '81'}, {'cat': 'marco', 'label': '80'}, {'cat': 'UNIRAS', 'label': '79'}, {'cat': 'thomas', 'label': '78'}, {'cat': 'GKS', 'label': '76'}, {'cat': 'G', 'label': '75'}, {'cat': 'XnView', 'label': '74'}, {'cat': 'GraphicsMagick', 'label': '74'}, {'cat': 'li', 'label': '73'}, {'cat': 'U-PS', 'label': '71'}, {'cat': 'https', 'label': '70'}, {'cat': 'SciPlot', 'label': '70'}, {'cat': 'ctioga2', 'label': '69'}, {'cat': 'ACDSee', 'label': '69'}, {'cat': 'dell', 'label': '69'}, {'cat': 'PDFCreator', 'label': '69'}, {'cat': 'Yang', 'label': '69'}, {'cat': 'Picasa', 'label': '68'}, {'cat': 'POV-Ray', 'label': '68'}, {'cat': 'MacDraw', 'label': '68'}, {'cat': 'Id', 'label': '67'}, {'cat': 'Windows', 'label': '67'}, {'cat': 'Martin', 'label': '67'}, {'cat': 'psmerge', 'label': '66'}, {'cat': 'Xvgr', 'label': '66'}, {'cat': 'John', 'label': '65'}, {'cat': 'S-PLUS', 'label': '64'}, {'cat': 'DeltaGraph', 'label': '64'}, {'cat': 'BI', 'label': '63'}, {'cat': 'Mohammad', 'label': '63'}, {'cat': 'Autodesk', 'label': '62'}, {'cat': 'VTK', 'label': '62'}, {'cat': 'QuickTime', 'label': '62'}, {'cat': 'Liu', 'label': '62'}, {'cat': 'RAD', 'label': '61'}, {'cat': 'PrimoPDF', 'label': '60'}
        ],
        render: {
          item: function(item, escape) {
              return '<div>' +
                  (item.cat ? '<span class="cat">' + escape(item.cat) + ' </span>' : '') +
                  (item.label ? '<span class="label small">(~' + escape(item.label) + ' in total)</span>' : '') +
              '</div>';
          },
          option: function(item, escape) {
              var label = item.cat || item.label;
              var caption = item.cat ? item.label : null;
              return '<div>' +
                  '<span class="label">' + escape(label) + ' </span>' +
                  (caption ? '<span class="caption small">(~' + escape(caption) + ' in total)</span>' : '') +
              '</div>';
          }
        },
        create: function(input) {
            return {
                cat: input,
                // label: input
            }
        }
    });
    var creatorSelect = $select[0].selectize;

    var $ifSelect = $('#imageformat').selectize({
        create: false,
        // sortField: 'text'
        plugins: ['remove_button', 'enter_key_submit'],
        onInitialize: function () {
          this.on('submit', function () {
            this.$input.closest('form').submit();
          }, this);
        },
    });
    var ifSelect = $ifSelect[0].selectize;

    var titleSelect = $('#title').selectize({
        create: true,
        // sortField: 'text'
        maxItems: 1,
        plugins: ['remove_button', 'enter_key_submit'],
        onInitialize: function () {
          this.on('submit', function () {
            this.$input.closest('form').submit();
          }, this);
        },
        persist: true,
    });
    var titleSelect = titleSelect[0].selectize;

    var captionSelect = $('#caption').selectize({
        create: true,
        // sortField: 'text'
        maxItems: 1,
        plugins: ['remove_button', 'enter_key_submit'],
        onInitialize: function () {
          this.on('submit', function () {
            this.$input.closest('form').submit();
          }, this);
        },
    });
    var captionSelect = captionSelect[0].selectize;

    // activate tooltips
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })

    {#
    {% if prev_image_id %}
      $("#image_id").val( {{ prev_image_id }} );
    {% endif %}
    #}

    {% if embedding %}
      console.log({{embedding|tojson}});
      var emVal = {{embedding|tojson}};
      $("#embedding").val(emVal);
    {% endif %}

    console.log({{search_select|tojson}});
    var emVal = {{search_select|tojson}};
    if(emVal === "on") {
      console.log("toggling checkbox");
      $("#search_select").val("on");
      checkbox.checked = 1;
    }
    toggleMode();

    {% if (nFilters == 1 and not category) or (nFilters > 1) %}
      console.log("some filters active");
      $("#filter-content").collapse('toggle');
    {% endif %}

    {% if category %}
      console.log({{category|tojson}});
      var catVal = {{category|tojson}};
      categorySelect.setValue(catVal.split(","), 1);
      loadCategoryName({{category|tojson}});
    {% endif %}

    {% if category_name %}
      console.log({{category_name|tojson}});
      var catVal = {{category_name|tojson}};
      categoryNameSelect.setValue(catVal.split(","), 1);
    {% endif %}

    {% if imageformat %}
      console.log({{imageformat|tojson}});
      var imVal = {{imageformat|tojson}};
      ifSelect.setValue(imVal, 1);
    {% endif %}

    {#
    {% if author %}
      console.log({{author|tojson}});
      var authorVal = {{author|tojson}};
      authorSelect.setValue(authorVal, 1);
    {% endif %}
    #}

    {% if prediction %}
      var predVal = {{prediction|tojson}};
      console.log("prediction: " + predVal);
      predictionSelect.createItem(predVal, false);
      console.log("finished loading prediction");
    {% endif %}

    {% if title %}
      console.log({{title|tojson}});
      var titleVal = {{title|tojson}};
      titleSelect.addOption({value:titleVal,text:titleVal});
      titleSelect.setValue(titleVal, 1);
    {% endif %}

    {% if creator %}
      console.log({{creator|tojson}});
      var creatorVal = {{creator|tojson}};
      creatorSelect.createItem(creatorVal, false);
    {% endif %}

    {% if caption %}
      console.log({{caption|tojson}});
      var captionVal = {{caption|tojson}};
      captionSelect.addOption({value:captionVal,text:captionVal});
      captionSelect.setValue(captionVal, 1);
    {% endif %}

    {% if date_start %}
      console.log({{date_start|tojson}});
      var dsVal = {{date_start|tojson}};
      var ds = document.getElementById("date-start");
      ds.value = dsVal;
    {% endif %}

    {% if date_end %}
      console.log({{date_end|tojson}});
      var deVal = {{date_end|tojson}};
      var de = document.getElementById("date-end");
      de.value = deVal;
    {% endif %}

    console.log( {{ metadict|tojson }} );
    console.log( {{ si_meta_d|tojson }} );

    $('#container').imagesLoaded()
    .always( function( instance ) {
      console.log('all images loaded');
    })
    .done( function( instance ) {
      console.log('all images successfully loaded');
    })
    .fail( function() {
      console.log('all images loaded, at least one is broken');
    })
    .progress( function( instance, image ) {
      var result = image.isLoaded ? 'loaded' : 'broken';
      console.log( 'image is ' + result + ' for ' + image.img.src );
    });
  });

  $(window).on('load', function(){
		$(".wrapper").animate({
			opacity: 1
		});
		$('#loading').hide()
	})

  </script>

{% endblock %}
